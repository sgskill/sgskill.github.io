!function(){"use strict";class t{constructor(){}static init(){Laya.ClassUtils.regClass}}t.width=750,t.height=1334,t.scaleMode=Laya.Stage.SCALE_SHOWALL,t.alignV=Laya.Stage.ALIGN_MIDDLE,t.alignH=Laya.Stage.ALIGN_CENTER,t.debug=!1,t.stat=!1,t.physicsDebug=!1,t.exportSceneToJson=!0,t.fguitype="json",t.init();class e{}e.activity_location="http://mwx.sanguosha.com/card_2020_new",e.plat_api="http://mwx.sanguosha.com",e.domain="http://mwxllk.sanguosha.com/gamellk_new",e.resVersion="2.0.4",e.debug_log=!1,e.offset_top=0;var i=Laya.Sprite;class s{static init(t){this._root=new i,this._root.name="root",this._root.size(Laya.stage.width,Laya.stage.height),Laya.stage.addChild(this._root),this._bg=new fairygui.GLoader,this._root.addChild(this._bg.displayObject);for(let e=0;e<t.length;e++)this.createLayer(t[e])}static createLayer(t){let e=new i;e.name=t,e.mouseThrough=!0,e.size(Laya.stage.width,Laya.stage.height),this._root.addChild(e)}static getLayer(t){return this._root.getChildByName(t)}static get root(){return this._root}}s.LAY_SCENE="scene",s.LAY_GUI="gui",s.LAY_TOP="top",s.LAY_TIP="tip";class a{constructor(t=""){this._resList=[],this._name=t}onInit(){}complete(){this._complete=!0,this.completeHandler.run()}init(){this.onInit()}start(){throw Error("must be overrided")}dispose(){}get progress(){return 1}}class n{}n.log=((t,i)=>{e.debug_log&&console.log(`[${n.getTimeHMS()}][${t}]`,i)}),n.getTimeHMS=(()=>{const t=new Date;return`${t.getHours()}:${t.getMinutes()}:${t.getSeconds()}--\x3e`});class o{constructor(){this.code="",this.chl="",this.openid="",this.sessionId="",this.level=-1,this.competition_level=-1,this.rule_alert=1}}class l{}l.isWXPlatform=(()=>!(!Laya.Browser.onWeiXin&&!Laya.Browser.onMiniGame));const r=(t,e=!1)=>_("ui/"+t,e),h=(t,e=!1)=>_("spine/"+t,e),c=(t,e=!1)=>_("sound/"+t,e),_=(t,e=!1)=>d("res/"+t,e),d=(t,i=!1)=>l.isWXPlatform()?i||0==e.domain.length||"0"==e.resVersion?t:e.domain+"/"+t:0==e.domain.length?t:e.domain+"/"+t;class u{constructor(t,e){fairygui.UIPackage.addPackage(r("Common")),this._ui=fairygui.UIPackage.createObject("Common","comTipDlg"),this._tipTxt=this._ui.getChild("tipTxt").asTextField,this._closeBtn=this._ui.getChild("close").asButton,this._closeBtn.onClick(this,this.onClose),this._comBtn=this._ui.getChild("comBtn").asButton,this._comBtn.onClick(this,this.onCommit),this._cDlg=this._ui.getController("cDlg"),this._commitFunc=t,this._closeFunc=e}get ui(){return this._ui}set commitFunc(t){this._commitFunc=t}set closeFunc(t){this._closeFunc=t}setTipText(t){t&&(this._tipTxt.text=t)}setTipType(t){t&&this._cDlg.setSelectedIndex(t)}setBtnText(t){t&&(this._comBtn.title=t)}onClose(){this._ui.displayObject.removeSelf(),this._closeFunc&&this._closeFunc.run()}onCommit(){this._ui.displayObject.removeSelf(),this._commitFunc&&this._commitFunc.run()}}class m{static showComTipDlg(t){fgui.UIPackage.loadPackage(r("Common"),Laya.Handler.create(this,()=>{let e=new u;e.setTipText(t),s.getLayer("tip").addChild(e.ui.displayObject)}))}static showCommitDlg(t,e,i,a){fgui.UIPackage.loadPackage(r("Common"),Laya.Handler.create(this,()=>{let n=new u(i,a);n.setTipText(t),n.setBtnText(e),n.setTipType(1),s.getLayer("tip").addChild(n.ui.displayObject)}))}}const g=CryptoJS.enc.Utf8.parse("e6A#9b4*%47e5Db6"),p=CryptoJS.enc.Utf8.parse("12df*(jxwG&JgFD#");class C extends Laya.EventDispatcher{constructor(){super()}static get instance(){return C._instance||(C._instance=new C)}request(t,i,s=null,a=null,o=!1){(i=i||{}).version=e.resVersion;let l=JSON.stringify(i);o&&(l=function(t){let e=CryptoJS.enc.Utf8.parse(t);return CryptoJS.AES.encrypt(e,g,{iv:p,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}).ciphertext.toString().toUpperCase()}(l));let r=e.plat_api+t,h=new Laya.HttpRequest;h.http.timeout=1e4,h?(h.once(Laya.Event.COMPLETE,this,function(t){n.log("COMPLETE",t),10001==(t.ret||0)?Laya.Browser.window.location.href=t.redirect:s&&s.runWith(t)}),h.once(Laya.Event.ERROR,this,function(t){n.log("ERROR",t),a&&a.runWith(t),"string"==typeof t?(t.length>30&&(t=t.substr(1,30)),m.showComTipDlg("网络异常："+t)):m.showComTipDlg(t)}),o?h.send(r+`?t=${(new Date).getTime()}`,l,"post","json",["Accept","application/json","Content-Type","text/plain"]):h.send(r+`?t=${(new Date).getTime()}`,l,"post","json",["Accept","application/json","Content-Type","application/json"]),n.log("Net",r),n.log(t,l),o&&n.log(t,function(t){let e=CryptoJS.enc.Hex.parse(t),i=CryptoJS.enc.Base64.stringify(e);return CryptoJS.AES.decrypt(i,g,{iv:p,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}).toString(CryptoJS.enc.Utf8).toString()}(l))):n.log("微信Http请求对象无法创建")}}class L{}L.Player_Data="/api/v2/link/user",L.Game_Start="/api/v2/link/game/start",L.Game_Commit="/api/v2/link/game/commit",L.Game_Share="/api/v2/link/poster/share",L.Game_Battle="/api/v2/link/poster/battle",L.Game_Level="/api/v2/link/game/level",L.Game_Prize="/api/v2/link/prize/get",L.Game_Log="/api/v2/link/log";class y extends Laya.EventDispatcher{constructor(){super(),this._user=null,this._user=new o}static get Instance(){return y._instance||(y._instance=new y)}get user(){return this._user}get openId(){return this._user.openid}get sessionId(){return this._user.sessionId}init(t,e){t&&e&&(this._user.code=t,this._user.chl=e)}getPlayerData(t){C.instance.request(L.Player_Data,{code:this._user.code,chl:this._user.chl},Laya.Handler.create(this,this.getPlayerDataOk,[t]),Laya.Handler.create(this,this.getPlayerDataOk,[t]))}getPlayerDataOk(t,e){e&&0==e.ret?(this._user.openid=e.data.openid,this._user.level=e.data.level,this._user.rule_alert=e.data.rule_alert,e.data.scan_card&&(this._user.competition_level=e.data.scan_card.level)):m.showComTipDlg(e.error),t()}getGameData(t){let e=this.getGameLevel();C.instance.request(L.Game_Start,{openid:y.Instance.openId,code:this._user.code,chl:this._user.chl,level:e},Laya.Handler.create(this,this.getGameDataOk,[t]),null,!0)}getGameDataOk(t,e){!e||0!=e.ret&&8888!=e.ret?m.showComTipDlg(e.error):(this._user.sessionId=e.data.sessionId,t(e))}getGameLevel(){let t=this._user.level;return this._user.competition_level>=0&&(t=this._user.competition_level),t}setGameLevel(t){this._user.level=t}setGameNextLevel(){this._user.level=this._user.level+1}isBattle(){return this._user.competition_level>=0}}class w extends Laya.EventDispatcher{constructor(){super(),this.urlData=null,this.window=Laya.Browser.window}static get instance(){return w._instance||(w._instance=new w)}geturlAlldata(){return this.window.location.href}getUrlProtocol(){return this.window.location.protocol}getUrlParams(t=null){let e={},i=this.window.location.search;if(1==i.indexOf("?"))return!1;var s=i?i.split("?")[1]:i.slice(1);i=s.split("&");var a;t=t||"";for(let t=0;t<i.length;t++){let s=i[t].split("=");e[s[0]]=decodeURI(s[1])}return t?e[t]&&(a=e[t]):a=e,this.urlData||(this.urlData=e),a}}class f extends a{constructor(){super()}onInit(){super.onInit(),this._counter=0}start(){this.progressHandler.runWith("加载URL上的信息");var t=w.instance.getUrlParams();n.log(t),y.Instance.init(t.code,t.chl),y.Instance.getPlayerData(this.getUserDataOK.bind(this))}getUserDataOK(){this.complete()}dispose(){super.dispose()}get progress(){return 10}}var v=Laya.Handler;class T extends Laya.Scene{constructor(){super(),this._resLoaded=!1,this._sceneData=null}start(){this.onPrepare(),this.loadRes(),this.loadData()}init(t){this._sceneData=t}show(t){this.visible=!0,this.onShow(t)}hide(){this.visible=!1,this.onHide()}close(){this.onClose()}update(t=null){}loadData(){}get res(){return[]}loadRes(){0!==this.res.length?Laya.loader.load(this.res,v.create(this,this.onResLoad),v.create(this,this.onResProgress,null,!1)):this.onResLoad()}onResProgress(t){}onResLoad(t=null){null==t||1==t?(this._resLoaded=!0,this.checkComplete()):this.event(T.EVENT_UI_SHOW,1)}checkComplete(){this._resLoaded&&(this.onInit(this._sceneData),this.onShow(1),this.event(T.EVENT_UI_SHOW,0))}onPrepare(){}onInit(t){}onShow(t){}onHide(){}onClose(){}}T.EVENT_UI_SHOW="UIShow";class D{static get current(){return this._current}static show(t,e=s.LAY_SCENE,i=null,a=null){if(this._loading)return;this._loading=!0;let o=s.getLayer(e);t.on(T.EVENT_UI_SHOW,this,e=>{0==e?(o.addChild(t),this._sceneList.push(t),this._current=t):n.log("UI页面打开失败"),this._loading=!1,i&&i.runWith(e)}),t.init(a),t.start()}static back(t){if(this._loading)return;let e=this._sceneList.pop();null!=e&&(s.getLayer(s.LAY_SCENE).removeChild(e),e.close(),e=null,this._current=null,this._sceneList.length>0&&(this._current=this._sceneList[this._sceneList.length-1],this._current.show(t)))}static remove(t){if(this._current&&this._current.name==t)this.back();else for(let e=0;e<this._sceneList.length;e++){let i=this._sceneList[e];if(t==i.name){this._sceneList.splice(e,1),s.getLayer(s.LAY_SCENE).removeChild(i),i.close();break}}}static backToStage(){let t=0;for(let e=0;e<this._sceneList.length;e++){let i=this._sceneList[e];"Home"!=i.name&&(t+=1,s.getLayer(s.LAY_SCENE).removeChild(i),i.close())}t>0&&(this._sceneList.splice(1,t),this._current=this._sceneList[0],this._current.show())}}D._sceneList=[],D._loading=!1;var I=fairygui.UIPackage;class E extends T{constructor(){super()}onPrepare(){}onInit(t=null){}onInitBase(t,e){this.name=t,I.addPackage(r(t)),this._ui=I.createObject(t,e),this.addChild(this._ui.displayObject),s.getLayer(s.LAY_SCENE).event(T.EVENT_UI_SHOW,t)}onShow(t){}onHide(){}onClose(){null!=this._ui&&this.removeChild(this._ui.displayObject),this._ui=null}}class S{constructor(t){this._ui=t}init(t=null){this.onInitUI(t),this.onInitEvent()}onInitUI(t=null){throw new Error("this function must be override!")}onInitEvent(){}onRemoveEvent(){}get ui(){return this._ui}dispose(){this.onRemoveEvent(),this._ui&&this._ui.parent&&this._ui.parent.removeChild(this._ui),this._ui=null}}class A extends Laya.EventDispatcher{constructor(){super()}static get instance(){return A._instance||(A._instance=new A)}}class O{}O.E_TimerEnd="E_TimerEnd",O.E_ClickChess="E_ClickChess",O.E_GameWin="E_GameWin",O.E_CloseDlg="E_CloseDlg",O.E_GameRestart="E_GameRestart",O.E_CloseRuleDlg="E_CloseRuleDlg",O.E_Visibility_Background="E_Visibility_Background",O.E_Visibility_Foreground="E_Visibility_Foreground";class x extends fairygui.GComponent{constructor(t,e){super(),this._ui=t,this._timeTxt=this._ui.getChild("countdownTxt").asTextField,this._cTime=this._ui.getController("cTime"),this.resetTimer(e)}get totalTime(){return this._totalTime}get timeUse(){return this._totalTime-this._curTime}get timeLeft(){return this._curTime}getTimerIndex(){return 0===this._timeSpace?0:Math.ceil(this._curTime/this._timeSpace)}updateTimerImg(){let t=this.getTimerIndex();this._cTime.setSelectedIndex(t)}updateTimerTxt(){this._timeTxt.text=`${this._curTime}秒`}updateTime(){this._curTime-=1,this.updateTimerImg(),this.updateTimerTxt(),this._curTime<=0&&(this._timerId&&(clearInterval(this._timerId),this._timerId=null),n.log("时间到了游戏结束"),A.instance.event(O.E_TimerEnd))}clearTimer(){this._totalTime=0,this._curTime=0,this._timeSpace=0,this.updateTimerImg(),this.updateTimerTxt()}resetTimer(t){t&&(this._recvTime=Math.round((new Date).getTime()/1e3),this._totalTime=t,this._curTime=this._totalTime,this._timeSpace=Math.ceil(this._totalTime/x.MAX_COUNT),this.updateTimerImg(),this.updateTimerTxt(),this._timerId&&(clearInterval(this._timerId),this._timerId=null),this._timerId=setInterval(()=>{this.updateTime()},1e3))}endTimer(){return this._timerId&&(clearInterval(this._timerId),this._timerId=null),this._totalTime-this._curTime}setTimerTxt(t){this._timeTxt.text=`${t}秒`}checkTime(){let t=Math.round((new Date).getTime()/1e3)-this._recvTime;this._curTime=this._totalTime-t,t<0&&(this._curTime=0)}}x.MAX_COUNT=7;class b extends Laya.EventDispatcher{constructor(){super()}static get Instance(){return b._instance||(b._instance=new b)}loadSpineRes(){this.spine_eliminate=new Laya.Templet,this.spine_eliminate.loadAni(h("xiaoxiaole_eff_xiaochu.sk")),this.spine_eliminate.on(Laya.Event.LOADED,this,()=>{this.spine_eliminate_loaded=!0})}}class B{constructor(t){this._spine=null,this._data=t,this._ui=fairygui.UIPackage.createObject("Game","chess"),this._chessBtn=this._ui.getChild("chessBtn").asButton,this._chessBtn.icon=`ui://Game/chess_${this._data.id}`,this._chessBtn.onClick(this,this.onClickChessBtn),this._chessBox=this._ui.getChild("chessBox").asImage}onClickChessBtn(){A.instance.event(O.E_ClickChess,this._data)}get ui(){return this._ui}get data(){return this._data}set data(t){this._data=t}get chess(){return this._chessBtn}onShow(t){this._chessBtn.alpha=0,t?Laya.timer.once(t,this,()=>{this._ui&&this._ui.getTransition("t1").play()}):this._ui&&this._ui.getTransition("t1").play()}onHited(){this._chessBox.visible=!0}onClearHited(){this._chessBox.visible=!1}onEliminated(){this._chessBtn.touchable=!1,this._chessBtn.offClick(this,this.onClickChessBtn),this._ui.getTransition("t0").play(),b.Instance.spine_eliminate_loaded&&(this._spine=b.Instance.spine_eliminate.buildArmature(0),this._spine.x=43.5,this._spine.y=43.5,this._spine.scale(1.14,1.14),this._spine.play(0,!1),this._ui.displayObject.addChild(this._spine)),Laya.timer.once(500,this,()=>{this._ui&&(this._ui.removeFromParent(),this._ui=null)})}onRemove(){this._chessBtn.offClick(this,this.onClickChessBtn),this._ui&&(this._ui.removeFromParent(),this._ui=null)}}class k{constructor(){this._ui=fairygui.UIPackage.createObject("Game","line"),this._lineStraight=this._ui.getChild("line1").asImage,this._lineTurn=this._ui.getChild("line2").asImage}get ui(){return this._ui}showLineStraight(t,e=!0){this._lineStraight.visible=!0,this._lineTurn.visible=!1,t&&(this._lineStraight.rotation=t),e&&this.onRemove()}showLineTurn(t,e=!0){this._lineStraight.visible=!1,this._lineTurn.visible=!0,t&&(this._lineTurn.rotation=t),e&&this.onRemove()}onRemove(t=!1){this._ui.getTransition("t0").play(),t?this._ui&&(this._ui.removeFromParent(),this._ui=null):Laya.timer.once(700,this,()=>{this._ui&&(this._ui.removeFromParent(),this._ui=null)})}}class R extends Laya.EventDispatcher{constructor(){super(),this._soundState=0,this._musicState=0,this._isStop=!1}static get instance(){return this._instance||(this._instance=new R)}get sound_state(){return this._soundState}set sound_state(t){this._soundState=t}get music_state(){return this._musicState}set music_state(t){this._musicState=t}init(){if(!l.isWXPlatform())return;this.initSound();let t=Laya.Browser.window.wx;t.onShow(function(t){R.instance.updatepdateSound()}),t.onHide(function(){R.instance.stopAll()})}initSound(){this.playMusic("bgm");if(l.isWXPlatform()){let t=Laya.Browser.window.wx;t.onAudioInterruptionEnd(function(){this.playMusic("bgm")}),t.onAudioInterruptionBegin(function(){Laya.SoundManager.stopMusic()})}}updatepdateSound(t=null){if(this.isPlay())if(1==this.sound_state&&Laya.SoundManager.stopAllSound(),1==this.music_state)Laya.SoundManager.stopMusic();else{let t=D.current.name;-1==t.search("Relive")&&-1==t.search("Result")&&this.playMusic("bgm")}}isPlay(){return 1!=this.music_state}stopAll(){Laya.SoundManager.stopAll()}playBgMusic(t){1!=this.music_state&&Laya.SoundManager.playMusic(c(t+".mp3",!1),0)}playMusic(t){1!=this.music_state&&Laya.SoundManager.playMusic(c(t+".mp3",!1))}playSound(t){1!=this.sound_state&&Laya.SoundManager.playSound(c(t+".mp3",!1))}}class H extends fairygui.GComponent{constructor(t){super(),this._isTishiOpen=!1,this._ui=t,this.resetData(),this.onInitEvent()}onInitEvent(){A.instance.on(O.E_ClickChess,this,t=>{if(n.log(`chess id: ${t.id}  row: ${t.row}  col: ${t.col}`),this._isGameOver)return;if(this._isIndent)return;if(this._hitChessData.length>=2)return;if(-1==this._boardData[t.row][t.col])return;let e=this._chessArray[t.index];e&&e.onHited(),R.instance.playSound("hit"),this._hitChessData.push(t),this.checkHit()})}resetData(){this._boardData=[],this._hitChessData=[],this._chessArray=[],this._isGameOver=!1,this._boardDataInit=[],this._eliminateLog=[],this._changeBoardLog={},this._tempLineArray=[],this._isIndent=!1}loadGameConfig(t){this._levelConfig=t,n.log("levelConfig",this._levelConfig),this.startGame()}gameOver(){this._isGameOver=!0}clearBoard(){for(let t=0;t<this._chessArray.length;t++){let e=this._chessArray[t];e&&e.onRemove()}for(let t=0;t<this._tempLineArray.length;t++){let e=this._tempLineArray[t];e&&e.onRemove(!0)}}startGame(){this.resetData();let t=0;for(let e=0;e<H.MAX_ROW;e++){let i=!1;for(let t=0;t<this._levelConfig.emptyRow.length;t++)e==this._levelConfig.emptyRow[t]&&(i=!0);this._boardData[e]=[],this._boardDataInit[e]=[];for(let s=0;s<H.MAX_COL;s++){let a=!1;for(let t=0;t<this._levelConfig.emptyCol.length;t++)s==this._levelConfig.emptyCol[t]&&(a=!0);let n=!1;for(let t=0;t<this._levelConfig.emptyTile.length;t++)e==this._levelConfig.emptyTile[t][0]&&s==this._levelConfig.emptyTile[t][1]&&(n=!0);this._boardData[e][s]=0,this._boardDataInit[e][s]=0,t+=1,(i||a||n)&&(this._boardData[e][s]=-1,this._boardDataInit[e][s]=-1,t-=1)}}let e=1e3/t,i=[],s=[],a=[];for(let t=0;t<H.MAX_CHESS_NUM;t++)a[t]=t;for(let e=0;e<t;e+=2){let t=0;if(s.length<this._levelConfig.chessKindNum){t=a[Math.floor(Math.random()*a.length)],s.push(t);let e=a.indexOf(t);e>-1&&a.splice(e,1)}else t=s[Math.floor(Math.random()*s.length)];i[e]=t,i[e+1]=t}for(;t;){let e=Math.floor(Math.random()*t--),s=i[t];i[t]=i[e],i[e]=s}let o=0;for(let t=0;t<H.MAX_ROW;t++)for(let s=0;s<H.MAX_COL;s++)if(0==this._boardData[t][s]){let a=i.shift();this._boardData[t][s]=a,this._boardDataInit[t][s]=a;let n=new B({id:this._boardData[t][s],col:s,row:t,index:t*H.MAX_COL+s});n.ui.setXY(s*H.CELL_WIDTH,t*H.CELL_WIDTH),this._ui.addChild(n.ui),this._chessArray[t*H.MAX_COL+s]=n,n.onShow(o*e),o++}n.log("boardData",this._boardData),this.canContinueEliminate()||(n.log("开局无法消除"),this._resetLeftChessCount=0,this.resetLeftChess())}checkHit(){if(1==this._hitChessData.length);else if(2==this._hitChessData.length){let t=this.canEliminate(this._hitChessData[0],this._hitChessData[1]);n.log("checkHit",t);let e=this._hitChessData[0],i=this._hitChessData[1];if(this._boardData[e.row][e.col]==e.id&&this._boardData[i.row][i.col]==i.id||(t={ret:0,path:[]}),t.ret>0){R.instance.playSound("eliminate"),this.onLineHitChess(t.path);let e=this._chessArray[this._hitChessData[0].index],i=this._chessArray[this._hitChessData[1].index];if(e&&e.onEliminated(),i&&i.onEliminated(),this._chessArray[this._hitChessData[0].index]=null,this._chessArray[this._hitChessData[1].index]=null,this.removeEliminatedData(this._hitChessData[0],this._hitChessData[1]),this.checkGameOver())return this._hitChessData=[],n.log("消除完了游戏结束"),void A.instance.event(O.E_GameWin);this.checkIndent(this._hitChessData),this._hitChessData=[],this.canContinueEliminate()||(n.log("无法继续消除"),this._resetLeftChessCount=0,this.resetLeftChess()),this._isTishiOpen&&Laya.timer.once(500,this,()=>{this.showChessTiShi()})}else{let t=this._chessArray[this._hitChessData[0].index];t&&t.onClearHited(),this._hitChessData[0].index==this._hitChessData[1].index?this._hitChessData=[]:this._hitChessData.shift()}}}removeEliminatedData(t,e){let i=(new Date).getTime();this._eliminateLog.push({AId:t.id,BId:e.id,time:i,ARow:t.row,ACol:t.col,BRow:e.row,BCol:e.col}),this._boardData[t.row][t.col]=-1,this._boardData[e.row][e.col]=-1}isTileEmpty(t,e){return-1==this._boardData[t][e]}canEliminate(t,e){let i={ret:0,path:[]};return this._boardData[t.row][t.col]!=t.id||this._boardData[e.row][e.col]!=e.id?i:t.index==e.index?i:t.id!=e.id?i:(i=this.canEliminateHorizon(t,e)).ret>0?i:(i=this.canEliminateVertical(t,e)).ret>0?i:(i=this.canEliminateTurnOnce(t,e)).ret>0?i:((i=this.canEliminateTurnTwice(t,e)).ret,i)}canEliminateHorizon(t,e){let i={ret:0,path:[]};if(t.row!=e.row)return i;let s=Math.min(t.col,e.col),a=Math.max(t.col,e.col);for(let e=s+1;e<a;e++)if(!this.isTileEmpty(t.row,e))return i;return i.ret=1,i.path.push(t),i.path.push(e),i}canEliminateVertical(t,e){let i={ret:0,path:[]};if(t.col!=e.col)return i;let s=Math.min(t.row,e.row),a=Math.max(t.row,e.row);for(let e=s+1;e<a;e++)if(!this.isTileEmpty(e,t.col))return i;return i.ret=2,i.path.push(t),i.path.push(e),i}canEliminateTurnOnce(t,e){let i={ret:0,path:[]},s={row:t.row,col:e.col},a={row:e.row,col:t.col};if(this.isTileEmpty(s.row,s.col)){let a=this.canEliminateHorizon(t,s),n=this.canEliminateVertical(e,s);if(a.ret>0&&n.ret>0)return i.ret=3,i.path.push(t),i.path.push(s),i.path.push(e),i}if(this.isTileEmpty(a.row,a.col)){let s=this.canEliminateHorizon(e,a),n=this.canEliminateVertical(t,a);if(s.ret>0&&n.ret>0)return i.ret=3,i.path.push(t),i.path.push(a),i.path.push(e),i}return i}canEliminateTurnTwice(t,e){let i={ret:0,path:[]};for(let s=t.row;s<H.MAX_ROW;){for(let a=t.col;a<H.MAX_COL;){if(s==t.row&&a==t.col||s==e.row&&a==e.col||s!=t.row&&s!=e.row&&a!=t.col&&a!=e.col||!this.isTileEmpty(s,a)){a<=t.col?(a-=1)<0&&(a=t.col+1):a+=1;continue}let n=this.canEliminateHorizon(t,{row:s,col:a}),o=this.canEliminateVertical(t,{row:s,col:a}),l=this.canEliminateTurnOnce(e,{row:s,col:a});if((n.ret>0||o.ret>0)&&l.ret>0)return i.ret=4,i.path.push(t),i.path.push({row:s,col:a}),i.path.push(l.path[1]),i.path.push(e),i;let r=this.canEliminateHorizon(e,{row:s,col:a}),h=this.canEliminateVertical(e,{row:s,col:a}),c=this.canEliminateTurnOnce(t,{row:s,col:a});if((r.ret>0||h.ret>0)&&c.ret>0)return i.ret=3,i.path.push(e),i.path.push({row:s,col:a}),i.path.push(c.path[1]),i.path.push(t),i;a<=t.col?(a-=1)<0&&(a=t.col+1):a+=1}s<=t.row?(s-=1)<0&&(s=t.row+1):s+=1}return i}canContinueEliminate(){for(let t=0;t<this._chessArray.length;t++)for(let e=t+1;e<this._chessArray.length;e++){let i=this._chessArray[t],s=this._chessArray[e];if(i&&s){if(this.canEliminate(i.data,s.data).ret>0)return!0}}return!1}resetLeftChess(){let t=[];for(let e=0;e<this._chessArray.length;e++)this._chessArray[e]&&t.push(this._chessArray[e].data);let i=t.length;for(;i;){let e=Math.floor(Math.random()*i--),s=t[i];t[i]=t[e],t[e]=s}let s=[];for(let e=0;e<H.MAX_ROW;e++)for(let i=0;i<H.MAX_COL;i++)if(this._boardData[e][i]>=0){let a=t.shift();this._boardData[e][i]=a.id;let n=this._chessArray[a.index];n.data.row=e,n.data.col=i,n.data.index=e*H.MAX_COL+i,s[e*H.MAX_COL+i]=n}if(this._chessArray=s,this._resetLeftChessCount=this._resetLeftChessCount+1,this.canContinueEliminate()){for(let t=0;t<H.MAX_ROW;t++)for(let e=0;e<H.MAX_COL;e++)if(this._boardData[t][e]>=0){let i=this._chessArray[t*H.MAX_COL+e];i&&Laya.timer.once(200,this,()=>{Laya.Tween.clearAll(i.ui),Laya.Tween.to(i.ui,{x:e*H.CELL_WIDTH,y:t*H.CELL_WIDTH},300,Laya.Ease.sineIn)})}let t=[],e=0;for(let i=0;i<H.MAX_ROW;i++){t[i]=[];for(let s=0;s<H.MAX_COL;s++)t[i][s]=this._boardData[i][s],e+=t[i][s]}this._changeBoardLog[e]=t}else{if(n.log("还是无法继续消除"),this._resetLeftChessCount>10)return void C.instance.request(L.Game_Log,{openid:y.Instance.openId,levelConfig:this._levelConfig,boardData:this._boardData,boardDataInit:this._boardDataInit,eliminateLog:this._eliminateLog,changeBoardLog:this._changeBoardLog,logVersion:e.resVersion});this.resetLeftChess()}}checkIndent(t){let e=[],i=[];if(i=i.concat(t),1!=this._levelConfig.indentType){if(this._levelConfig.indentRowTop){let t=-1,s=-1;for(let a=0;a<i.length;a++){let n=i[a];if(-1!=this._boardData[n.row][n.col])continue;if(this._levelConfig.indentRowTop[0]&&n.row+1<this._levelConfig.indentRowTop[0])continue;if(s!=n.col)s=n.col;else if(n.row>t)continue;t=n.row;let o=1,l=!1;for(let t=n.row+1;t<H.MAX_ROW;t++){if(!(this._levelConfig.indentRowTop.indexOf(t)>=0)){for(let i=1;i<=o;i++)this._boardData[t-i][n.col]=-1,this._chessArray[(t-i)*H.MAX_COL+n.col]=null,l&&e.push({row:t-i,col:n.col});break}{let e=this._chessArray[t*H.MAX_COL+n.col];if(!e){o++;continue}e.data.row=t-o,e.data.col=n.col,e.data.index=(t-o)*H.MAX_COL+n.col,this._chessArray[(t-o)*H.MAX_COL+n.col]=e,this._isIndent=!0,Laya.Tween.to(e.ui,{x:n.col*H.CELL_WIDTH,y:(t-o)*H.CELL_WIDTH},200,Laya.Ease.sineIn,Laya.Handler.create(this,()=>{this._isIndent=!1})),e.ui.sortingOrder=1+t-o,this._boardData[t-o][n.col]=this._boardData[t][n.col],l=!0}}}e.length>0&&(i=i.concat(e),e=[])}if(this._levelConfig.indentRowBottom){let t=-1,s=-1;for(let a=0;a<i.length;a++){let n=i[a];if(-1!=this._boardData[n.row][n.col])continue;if(this._levelConfig.indentRowBottom[0]&&n.row-1>this._levelConfig.indentRowBottom[0])continue;if(s!=n.col)s=n.col;else if(n.row<t)continue;t=n.row;let o=1,l=!1;for(let t=n.row-1;t>=0;t--){if(!(this._levelConfig.indentRowBottom.indexOf(t)>=0)){for(let i=1;i<=o;i++)this._boardData[t+i][n.col]=-1,this._chessArray[(t+i)*H.MAX_COL+n.col]=null,l&&e.push({row:t+i,col:n.col});break}{let e=this._chessArray[t*H.MAX_COL+n.col];if(!e){o++;continue}e.data.row=t+o,e.data.col=n.col,e.data.index=(t+o)*H.MAX_COL+n.col,this._chessArray[(t+o)*H.MAX_COL+n.col]=e,this._isIndent=!0,Laya.Tween.to(e.ui,{x:n.col*H.CELL_WIDTH,y:(t+o)*H.CELL_WIDTH},200,Laya.Ease.sineIn,Laya.Handler.create(this,()=>{this._isIndent=!1})),e.ui.sortingOrder=H.MAX_ROW-(t+o),this._boardData[t+o][n.col]=this._boardData[t][n.col],l=!0}}}e.length>0&&(i=i.concat(e),e=[])}if(this._levelConfig.indentColLeft){let t=-1,s=-1;for(let a=0;a<i.length;a++){let n=i[a];if(-1!=this._boardData[n.row][n.col])continue;if(this._levelConfig.indentColLeft[0]&&n.col+1<this._levelConfig.indentColLeft[0])continue;if(t!=n.row)t=n.row;else if(n.col>s)continue;s=n.col;let o=1,l=!1;for(let t=n.col+1;t<H.MAX_COL;t++){if(!(this._levelConfig.indentColLeft.indexOf(t)>=0)){for(let i=1;i<=o;i++)this._boardData[n.row][t-i]=-1,this._chessArray[n.row*H.MAX_COL+t-i]=null,l&&e.push({row:n.row,col:t-i});break}{let e=this._chessArray[n.row*H.MAX_COL+t];if(!e){o++;continue}e.data.row=n.row,e.data.col=t-o,e.data.index=n.row*H.MAX_COL+t-o,this._chessArray[n.row*H.MAX_COL+t-o]=e,this._isIndent=!0,Laya.Tween.to(e.ui,{x:(t-o)*H.CELL_WIDTH,y:n.row*H.CELL_WIDTH},200,Laya.Ease.sineIn,Laya.Handler.create(this,()=>{this._isIndent=!1})),e.ui.sortingOrder=1+t-o,this._boardData[n.row][t-o]=this._boardData[n.row][t],l=!0}}}e.length>0&&(i=i.concat(e),e=[])}if(this._levelConfig.indentColRight){let t=-1,s=-1;for(let a=0;a<i.length;a++){let n=i[a];if(-1!=this._boardData[n.row][n.col])continue;if(this._levelConfig.indentColRight[0]&&n.col-1>this._levelConfig.indentColRight[0])continue;if(t!=n.row)t=n.row;else if(n.col<s)continue;s=n.col;let o=1,l=!1;for(let t=n.col-1;t>=0;t--){if(!(this._levelConfig.indentColRight.indexOf(t)>=0)){for(let i=1;i<=o;i++)this._boardData[n.row][t+i]=-1,this._chessArray[n.row*H.MAX_COL+t+i]=null,l&&e.push({row:n.row,col:t+i});break}{let e=this._chessArray[n.row*H.MAX_COL+t];if(!e){o++;continue}e.data.row=n.row,e.data.col=t+o,e.data.index=n.row*H.MAX_COL+t+o,this._chessArray[n.row*H.MAX_COL+t+o]=e,this._isIndent=!0,Laya.Tween.to(e.ui,{x:(t+o)*H.CELL_WIDTH,y:n.row*H.CELL_WIDTH},200,Laya.Ease.sineIn,Laya.Handler.create(this,()=>{this._isIndent=!1})),e.ui.sortingOrder=H.MAX_COL-(t+o),this._boardData[n.row][t+o]=this._boardData[n.row][t],l=!0}}}e.length>0&&(i=i.concat(e),e=[])}}else{if(this._levelConfig.indentColLeft){let t=-1,s=-1;for(let a=0;a<i.length;a++){let n=i[a];if(-1!=this._boardData[n.row][n.col])continue;if(this._levelConfig.indentColLeft[0]&&n.col+1<this._levelConfig.indentColLeft[0])continue;if(t!=n.row)t=n.row;else if(n.col>s)continue;s=n.col;let o=1,l=!1;for(let t=n.col+1;t<H.MAX_COL;t++){if(!(this._levelConfig.indentColLeft.indexOf(t)>=0)){for(let i=1;i<=o;i++)this._boardData[n.row][t-i]=-1,this._chessArray[n.row*H.MAX_COL+t-i]=null,l&&e.push({row:n.row,col:t-i});break}{let e=this._chessArray[n.row*H.MAX_COL+t];if(!e){o++;continue}e.data.row=n.row,e.data.col=t-o,e.data.index=n.row*H.MAX_COL+t-o,this._chessArray[n.row*H.MAX_COL+t-o]=e,this._isIndent=!0,Laya.Tween.to(e.ui,{x:(t-o)*H.CELL_WIDTH,y:n.row*H.CELL_WIDTH},200,Laya.Ease.sineIn,Laya.Handler.create(this,()=>{this._isIndent=!1})),e.ui.sortingOrder=1+t-o,this._boardData[n.row][t-o]=this._boardData[n.row][t],l=!0}}}e.length>0&&(i=i.concat(e),e=[])}if(this._levelConfig.indentColRight){let t=-1,s=-1;for(let a=0;a<i.length;a++){let n=i[a];if(-1!=this._boardData[n.row][n.col])continue;if(this._levelConfig.indentColRight[0]&&n.col-1>this._levelConfig.indentColRight[0])continue;if(t!=n.row)t=n.row;else if(n.col<s)continue;s=n.col;let o=1,l=!1;for(let t=n.col-1;t>=0;t--){if(!(this._levelConfig.indentColRight.indexOf(t)>=0)){for(let i=1;i<=o;i++)this._boardData[n.row][t+i]=-1,this._chessArray[n.row*H.MAX_COL+t+i]=null,l&&e.push({row:n.row,col:t+i});break}{let e=this._chessArray[n.row*H.MAX_COL+t];if(!e){o++;continue}e.data.row=n.row,e.data.col=t+o,e.data.index=n.row*H.MAX_COL+t+o,this._chessArray[n.row*H.MAX_COL+t+o]=e,this._isIndent=!0,Laya.Tween.to(e.ui,{x:(t+o)*H.CELL_WIDTH,y:n.row*H.CELL_WIDTH},200,Laya.Ease.sineIn,Laya.Handler.create(this,()=>{this._isIndent=!1})),e.ui.sortingOrder=H.MAX_COL-(t+o),this._boardData[n.row][t+o]=this._boardData[n.row][t],l=!0}}}e.length>0&&(i=i.concat(e),e=[])}if(this._levelConfig.indentRowTop){let t=-1,s=-1;for(let a=0;a<i.length;a++){let n=i[a];if(-1!=this._boardData[n.row][n.col])continue;if(this._levelConfig.indentRowTop[0]&&n.row+1<this._levelConfig.indentRowTop[0])continue;if(s!=n.col)s=n.col;else if(n.row>t)continue;t=n.row;let o=1,l=!1;for(let t=n.row+1;t<H.MAX_ROW;t++){if(!(this._levelConfig.indentRowTop.indexOf(t)>=0)){for(let i=1;i<=o;i++)this._boardData[t-i][n.col]=-1,this._chessArray[(t-i)*H.MAX_COL+n.col]=null,l&&e.push({row:t-i,col:n.col});break}{let e=this._chessArray[t*H.MAX_COL+n.col];if(!e){o++;continue}e.data.row=t-o,e.data.col=n.col,e.data.index=(t-o)*H.MAX_COL+n.col,this._chessArray[(t-o)*H.MAX_COL+n.col]=e,this._isIndent=!0,Laya.Tween.to(e.ui,{x:n.col*H.CELL_WIDTH,y:(t-o)*H.CELL_WIDTH},200,Laya.Ease.sineIn,Laya.Handler.create(this,()=>{this._isIndent=!1})),e.ui.sortingOrder=1+t-o,this._boardData[t-o][n.col]=this._boardData[t][n.col],l=!0}}}e.length>0&&(i=i.concat(e),e=[])}if(this._levelConfig.indentRowBottom){let t=-1,s=-1;for(let a=0;a<i.length;a++){let n=i[a];if(-1!=this._boardData[n.row][n.col])continue;if(this._levelConfig.indentRowBottom[0]&&n.row-1>this._levelConfig.indentRowBottom[0])continue;if(s!=n.col)s=n.col;else if(n.row<t)continue;t=n.row;let o=1,l=!1;for(let t=n.row-1;t>=0;t--){if(!(this._levelConfig.indentRowBottom.indexOf(t)>=0)){for(let i=1;i<=o;i++)this._boardData[t+i][n.col]=-1,this._chessArray[(t+i)*H.MAX_COL+n.col]=null,l&&e.push({row:t+i,col:n.col});break}{let e=this._chessArray[t*H.MAX_COL+n.col];if(!e){o++;continue}e.data.row=t+o,e.data.col=n.col,e.data.index=(t+o)*H.MAX_COL+n.col,this._chessArray[(t+o)*H.MAX_COL+n.col]=e,this._isIndent=!0,Laya.Tween.to(e.ui,{x:n.col*H.CELL_WIDTH,y:(t+o)*H.CELL_WIDTH},200,Laya.Ease.sineIn,Laya.Handler.create(this,()=>{this._isIndent=!1})),e.ui.sortingOrder=H.MAX_ROW-(t+o),this._boardData[t+o][n.col]=this._boardData[t][n.col],l=!0}}}e.length>0&&(i=i.concat(e),e=[])}}}onLineHitChess(t){if(2==t.length){let e=t[0],i=t[1];if(e.row==i.row){let t=Math.min(e.col,i.col),s=Math.max(e.col,i.col);for(let i=t+1;i<s;i++){let t=new k;t.ui.setXY(i*H.CELL_WIDTH,e.row*H.CELL_WIDTH),this._ui.addChild(t.ui),t.showLineStraight(90,!this._isGameOver),this._isGameOver&&this._tempLineArray.push(t)}}if(e.col==i.col){let t=Math.min(e.row,i.row),s=Math.max(e.row,i.row);for(let i=t+1;i<s;i++){let t=new k;t.ui.setXY(e.col*H.CELL_WIDTH,i*H.CELL_WIDTH),this._ui.addChild(t.ui),t.showLineStraight(0,!this._isGameOver),this._isGameOver&&this._tempLineArray.push(t)}}}if(3==t.length){this.onLineHitChess([t[0],t[1]]),this.onLineHitChess([t[1],t[2]]);let e=new k;e.ui.setXY(t[1].col*H.CELL_WIDTH,t[1].row*H.CELL_WIDTH),this._ui.addChild(e.ui);let i=90*this.getQuadrant(t[0],t[2],t[1])-90;e.showLineTurn(i,!this._isGameOver),this._isGameOver&&this._tempLineArray.push(e)}if(4==t.length){this.onLineHitChess([t[0],t[1]]),this.onLineHitChess([t[1],t[2]]),this.onLineHitChess([t[2],t[3]]);let e=new k;e.ui.setXY(t[1].col*H.CELL_WIDTH,t[1].row*H.CELL_WIDTH),this._ui.addChild(e.ui);let i=90*this.getQuadrant(t[0],t[2],t[1])-90;e.showLineTurn(i,!this._isGameOver);let s=new k;s.ui.setXY(t[2].col*H.CELL_WIDTH,t[2].row*H.CELL_WIDTH),this._ui.addChild(s.ui);let a=90*this.getQuadrant(t[1],t[3],t[2])-90;s.showLineTurn(a,!this._isGameOver),this._isGameOver&&(this._tempLineArray.push(e),this._tempLineArray.push(s))}}getQuadrant(t,e,i){let s=0;return t.row<e.row&&t.col<e.col&&(i.row>t.row&&(s=0),i.col>t.col&&(s=2)),t.row<e.row&&t.col>e.col&&(i.row>t.row&&(s=3),i.col<t.col&&(s=1)),t.row>e.row&&t.col>e.col&&(i.row<t.row&&(s=2),i.col<t.col&&(s=0)),t.row>e.row&&t.col<e.col&&(i.row<t.row&&(s=1),i.col>t.col&&(s=3)),s}checkGameOver(){for(let t=0;t<this._chessArray.length;t++)if(this._chessArray[t])return!1;return!0}showLastChessCanEliminate(){for(let t=0;t<this._hitChessData.length;t++){let e=this._chessArray[this._hitChessData[t].index];e&&e.onClearHited()}this._hitChessData=[];for(let t=0;t<this._chessArray.length;t++)for(let e=t+1;e<this._chessArray.length;e++){let i=this._chessArray[t],s=this._chessArray[e];if(i&&s){let t=this.canEliminate(i.data,s.data);if(t.ret>0)return i.onHited(),s.onHited(),this._hitChessData.push(i.data),this._hitChessData.push(s.data),void this.onLineHitChess(t.path)}}}showChessTiShi(){for(let t=0;t<this._chessArray.length;t++)for(let e=t+1;e<this._chessArray.length;e++){let i=this._chessArray[t],s=this._chessArray[e];if(i&&s){if(this.canEliminate(i.data,s.data).ret>0)return i.onHited(),void s.onHited()}}}openChessTiShi(t){this._isTishiOpen=t}}H.MAX_COL=10,H.MAX_ROW=12,H.CELL_WIDTH=87,H.MAX_CHESS_NUM=25;const G=[{level:1,time:9999,chessKindNum:10,emptyCol:[0,1,2,7,8,9],emptyRow:[0,11],emptyTile:[]},{level:2,time:180,chessKindNum:10,emptyCol:[0,9],emptyRow:[0,11],emptyTile:[]},{level:3,time:180,chessKindNum:15,emptyCol:[0,9],emptyRow:[0,4,5,6,7,11],emptyTile:[]},{level:4,time:240,chessKindNum:20,emptyCol:[0,9],emptyRow:[0,11],emptyTile:[],indentColLeft:[1,2,3,4,5,6,7,8]},{level:5,time:240,chessKindNum:20,emptyCol:[0,9],emptyRow:[0,11],emptyTile:[],indentColRight:[8,7,6,5,4,3,2,1]},{level:6,time:180,chessKindNum:15,emptyCol:[0,4,5,9],emptyRow:[0,5,6,11],emptyTile:[]},{level:7,time:240,chessKindNum:25,emptyCol:[0,9],emptyRow:[0,11],emptyTile:[[1,1],[1,2],[2,1],[2,2],[3,1],[3,2],[1,7],[1,8],[2,7],[2,8],[3,7],[3,8],[8,1],[8,2],[9,1],[9,2],[10,1],[10,2],[8,7],[8,8],[9,7],[9,8],[10,7],[10,8]]},{level:8,time:240,chessKindNum:25,emptyCol:[0,9],emptyRow:[0,11],emptyTile:[],indentRowTop:[1,2,3,4,5,6,7,8,9,10]},{level:9,time:240,chessKindNum:25,emptyCol:[0,9],emptyRow:[0,11],emptyTile:[],indentRowBottom:[10,9,8,7,6,5,4,3,2,1]},{level:10,time:220,chessKindNum:25,emptyCol:[0,9],emptyRow:[0,11],emptyTile:[[1,1],[1,2],[1,3],[1,4],[2,1],[2,2],[2,3],[3,1],[3,2],[4,1],[7,8],[8,8],[8,7],[9,8],[9,7],[9,6],[10,8],[10,7],[10,6],[10,5]]},{level:11,time:220,chessKindNum:25,emptyCol:[0,9],emptyRow:[0,11],emptyTile:[[4,3],[4,4],[4,5],[4,6],[5,3],[5,4],[5,5],[5,6],[6,3],[6,4],[6,5],[6,6],[7,3],[7,4],[7,5],[7,6]]},{level:12,time:220,chessKindNum:25,emptyCol:[0,9],emptyRow:[0,11],emptyTile:[]},{level:13,time:220,chessKindNum:25,emptyCol:[0,9],emptyRow:[0,11],emptyTile:[[1,2],[1,4],[1,6],[1,8],[2,1],[2,3],[2,5],[2,7],[3,2],[3,4],[3,6],[3,8],[4,1],[4,3],[4,5],[4,7],[5,2],[5,4],[5,6],[5,8],[6,1],[6,3],[6,5],[6,7],[7,2],[7,4],[7,6],[7,8],[8,1],[8,3],[8,5],[8,7],[9,2],[9,4],[9,6],[9,8],[10,1],[10,3],[10,5],[10,7]]},{level:14,time:220,chessKindNum:25,emptyCol:[0,9],emptyRow:[0,11],emptyTile:[],indentRowTop:[7,8,9,10],indentRowBottom:[4,3,2,1],indentColRight:[8,7,6,5,4,3,2,1],indentType:1},{level:15,time:9999,chessKindNum:25,emptyCol:[0,9],emptyRow:[0,11],emptyTile:[],indentRowBottom:[10,9,8,7,6,5,4,3,2,1],indentColLeft:[6,7,8],indentColRight:[3,2,1]}];class M extends fairygui.GComponent{constructor(t){super(),this._ui=t,this._controller=this._ui.getController("c1"),this._timeSec=this._ui.getChild("time_s").asTextField,this._rewardTxt=this._ui.getChild("lab2").asTextField,this._minTimeTxt=this._ui.getChild("lab3").asTextField,this._restCntTxt=this._ui.getChild("lab5").asTextField,this._shareBtn=this._ui.getChild("shareBtn").asButton,this._addCntBtn=this._ui.getChild("addCntBtn").asButton,this._againBtn=this._ui.getChild("againBtn").asButton,this._nextBtn=this._ui.getChild("nextBtn").asButton,this._closeBtn=this._ui.getChild("closeBtn").asButton,this._shareBtn.onClick(this,this.onClickShare),this._addCntBtn.onClick(this,this.onClickAddCnt),this._againBtn.onClick(this,this.onClickAgain),this._nextBtn.onClick(this,this.onClickNext),this._closeBtn.onClick(this,this.onClose)}get ui(){return this._ui}onClickShare(){C.instance.request(L.Game_Battle,{record_id:this._data.record_id,times:this._data.timeUse},Laya.Handler.create(this,this.onClickShareOK))}onClickShareOK(t){m.showComTipDlg(t.error)}onClickAddCnt(){C.instance.request(L.Game_Share,null,Laya.Handler.create(this,this.onClickAddCntOK))}onClickAddCntOK(t){m.showComTipDlg(t.error)}onClickAgain(){A.instance.event(O.E_GameRestart)}onClickNext(){y.Instance.setGameNextLevel(),A.instance.event(O.E_GameRestart)}onClose(){this._shareBtn.offClick(this,this.onClickShare),this._addCntBtn.offClick(this,this.onClickAddCnt),this._againBtn.offClick(this,this.onClickAgain),this._againBtn.offClick(this,this.onClickNext),this._closeBtn.offClick(this,this.onClose),A.instance.event(O.E_CloseDlg)}showAddGameCnt(){this._controller.setSelectedIndex(7)}playStarAnim(t){this._ui.getTransition(`txx${t}`).play()}showResult(t){this._data=t,this.playStarAnim(t.star),this._timeSec.text=t.timeUse.toString(),1==t.star?this._minTimeTxt.text=`距离两星仅差${t.timeUse-(t.timeAll-30)}秒！`:2==t.star?this._minTimeTxt.text=`距离三星仅差${t.timeUse-(t.timeAll-60)}秒！`:t.timeUse<=t.mini_times||0==t.mini_times?this._minTimeTxt.text="创造了本关最短新纪录！":this._minTimeTxt.text=`距离本关最短记录仅差${t.timeUse-t.mini_times}秒！`,this._restCntTxt.text=t.residue,t.competition&&(this._restCntTxt.text=t.battle_residue);let e="",i="";for(let s of t.prize)1==s.prize_type||2==s.prize_type?e=e.length>0?e+"\n"+s.name:s.name:3==s.prize_type&&(i=s.name);e.length>0?this._rewardTxt.text=e:this._rewardTxt.text=i,t.competition?1==t.competition.result?(R.instance.playSound("gamewin"),this._controller.setSelectedIndex(5)):0==t.competition.result&&(R.instance.playSound("gamelose"),this._controller.setSelectedIndex(6)):1==t.result?(R.instance.playSound("gamewin"),t.residue>0?y.Instance.getGameLevel()==G.length-1?this._controller.setSelectedIndex(1):this._controller.setSelectedIndex(0):this._controller.setSelectedIndex(2)):0==t.result&&(R.instance.playSound("gamelose"),t.residue>0?this._controller.setSelectedIndex(3):this._controller.setSelectedIndex(4))}}class P extends fairygui.GComponent{constructor(t){super(),this._ui=t,this._closeBtn=this._ui.getChild("close").asButton,this._closeBtn.onClick(this,this.onClose)}get ui(){return this._ui}onClose(){this._closeBtn.offClick(this,this.onClose),A.instance.event(O.E_CloseRuleDlg)}}class X extends S{constructor(t){super(t),this._tishiOpen=!1,this._gameState=X.GS_WAITE}onInitUI(){this._bg=this._ui.getChild("bg").asImage,this._bg.y=this._bg.y-e.offset_top,this._cDig=this._ui.getController("cDlg"),this._timer=new x(this._ui.getChild("timer").asCom),this._board=new H(this._ui.getChild("gameBoard").asCom),this._overDlg=new M(this._ui.getChild("gameoverDlg").asCom),this._ruleDlg=new P(this._ui.getChild("gameRuleDlg").asCom),this._levelTxt=this._ui.getChild("levelTxt").asTextField,this._backBtn=this._ui.getChild("backBtn").asButton,this._tishiBtn=this._ui.getChild("tishiBtn").asButton,this._tishiBtn.visible=e.debug_log,this._level=y.Instance.getGameLevel(),this._level<0?m.showComTipDlg("游戏关卡无效"):(this._levelConfig=G[this._level],this._levelConfig?(this._levelTxt.text=`第${this._level+1}关`,this._timer.setTimerTxt(this._levelConfig.time),m.showCommitDlg("准备好了吗！","开始",Laya.Handler.create(this,this.initGame),Laya.Handler.create(this,this.onClickBack))):m.showComTipDlg("游戏关卡配置加载失败"))}onInitEvent(){this._backBtn.onClick(this,this.onClickBack),this._tishiBtn.onClick(this,this.onClickTiShi),A.instance.on(O.E_TimerEnd,this,()=>{this._timeUse=this._timer.timeUse,this._result=0,this.gameOver()}),A.instance.on(O.E_GameWin,this,()=>{this._timeUse=this._timer.endTimer(),this._result=1,this.gameOver()}),A.instance.on(O.E_CloseDlg,this,()=>{this._cDig.setSelectedIndex(0),1==this._result&&this.onClickBack()}),A.instance.on(O.E_GameRestart,this,()=>{this._cDig.setSelectedIndex(0),this.clearGame(),this.initGame()}),A.instance.on(O.E_CloseRuleDlg,this,()=>{this._cDig.setSelectedIndex(0),this.gameStart()}),A.instance.on(O.E_Visibility_Background,this,()=>{n.log("切到后台了")}),A.instance.on(O.E_Visibility_Foreground,this,()=>{n.log("切回前台了"),this._gameState==X.GS_PLAYING&&this._timer.checkTime(),this._timer.timeLeft<=0&&this._gameState==X.GS_PLAYING&&(this._timeUse=this._timer.timeUse,this._result=0,this.gameOver())})}onRemoveEvent(){this._backBtn.offClick(this,this.onClickBack),this._tishiBtn.offClick(this,this.onClickTiShi)}onClickBack(){this._gameState==X.GS_PLAYING?m.showCommitDlg("确定要退出吗？","确定",Laya.Handler.create(this,()=>{Laya.Browser.window.location.href=e.activity_location})):Laya.Browser.window.location.href=e.activity_location}playBGSound(){document.getElementById("musicid").play()}clearGame(){this._timer.clearTimer(),this._board.clearBoard(),this._gameState=X.GS_WAITE,this._commitSuccess=!1,this._commitTimerId&&(clearInterval(this._commitTimerId),this._commitTimerId=null)}initGame(){y.Instance.getGameData(this.gameStart.bind(this))}gameStart(t){return t&&8888==t.ret?(this._cDig.setSelectedIndex(1),void this._overDlg.showAddGameCnt()):0==y.Instance.user.rule_alert?(y.Instance.user.rule_alert=1,void this._cDig.setSelectedIndex(2)):(this._level=y.Instance.getGameLevel(),void(this._level<0?m.showComTipDlg("游戏关卡无效"):(this._levelConfig=G[this._level],this._levelConfig?(n.log("开始游戏"),this._gameState=X.GS_PLAYING,this._levelTxt.text=`第${this._level+1}关`,this._timer.resetTimer(this._levelConfig.time),this._board.loadGameConfig(this._levelConfig)):m.showComTipDlg("游戏关卡配置加载失败"))))}gameOver(){this._gameState!=X.GS_OVER&&(this._gameState=X.GS_OVER,this._board.gameOver(),0==this._result&&this._board.showLastChessCanEliminate(),C.instance.request(L.Game_Commit,{openid:y.Instance.openId,sessionId:y.Instance.user.sessionId,win:this._result,times:this._timeUse},Laya.Handler.create(this,this.onGameOverOK),Laya.Handler.create(this,this.onGameOverError),!0),this._commitTimerId&&(clearTimeout(this._commitTimerId),this._commitTimerId=null),this._commitTimerId=setTimeout(()=>{this._gameState!=X.GS_OVER||this._commitSuccess||m.showComTipDlg("游戏结算提交网络异常！")},1e4))}onGameOverOK(t){this._gameState==X.GS_OVER&&(this._commitSuccess=!0,0==this._result?Laya.timer.once(1500,this,()=>{this.showGameOverDlg(t)}):this.showGameOverDlg(t))}onGameOverError(t){this._gameState==X.GS_OVER&&(this._commitSuccess=!0)}showGameOverDlg(t){t&&0==t.ret?(0==t.data.win?this._timer.setTimerTxt(0):this._timer.setTimerTxt(this._timer.totalTime-t.data.times),this._cDig.setSelectedIndex(1),this._overDlg.showResult({timeAll:this._timer.totalTime,timeUse:t.data.times,result:t.data.win,prize:t.data.prize,mini_times:t.data.mini_times,residue:t.data.residue,battle_residue:t.data.battle_residue,competition:t.data.competition,record_id:t.data.record_id,level:t.data.level,star:t.data.star})):m.showComTipDlg(t.error)}onClickTiShi(){this._gameState==X.GS_PLAYING&&(this._tishiOpen=!this._tishiOpen,this._tishiOpen?this._tishiBtn.title="提示开":this._tishiBtn.title="提示关",this._board.openChessTiShi(this._tishiOpen),this._tishiOpen&&this._board.showChessTiShi())}}X.GS_WAITE=0,X.GS_PLAYING=1,X.GS_OVER=2;var U=Laya.Loader;class W extends E{constructor(){super()}get res(){return[{url:r("Game.json"),type:U.BUFFER},{url:r("Game_atlas0.png"),type:U.IMAGE},{url:r("Common.json"),type:U.BUFFER},{url:r("Common_atlas0.png"),type:U.IMAGE},{url:r("Common_lu8n2d.mp3"),type:U.SOUND},{url:c("hit.mp3"),type:U.SOUND},{url:c("eliminate.mp3"),type:U.SOUND},{url:c("gamewin.mp3"),type:U.SOUND},{url:c("gamelose.mp3"),type:U.SOUND}]}onInit(t){super.onInit(),fairygui.UIPackage.addPackage(r("Common")),this.onInitBase("Game","gameView"),this._view=new X(this._ui),this._view.init()}onClose(){super.onClose(),this._view&&this._view.dispose()}}class N{constructor(t){this._levelBtn=t,this._cXX=this._levelBtn.getController("cXX"),this._imgFlg=this._levelBtn.getChild("flagIcon").asImage,this._imgSelect=this._levelBtn.getChild("selectIcon").asImage}initUI(){this._star>0?this._levelBtn.icon=`ui://Level/level_on_${this._level+1}`:this._levelBtn.icon=`ui://Level/level_off_${this._level+1}`,this._cXX.setSelectedIndex(this._star)}initData(t){this._level=t.level,this._star=t.star,this.initUI()}setCurrent(){this._imgFlg.visible=!0,this._imgSelect.visible=!0}onPress(){this._levelBtn.setScale(.9,.9)}onRelease(){this._levelBtn.setScale(1,1)}}class F extends S{constructor(t){super(t),this._levelData={},this._levelBtns=[]}onInitUI(){this._levelView=this._ui.getChild("levelView").asCom,this._rewardBtn=this._levelView.getChild("levelBX").asButton,this._backBtn=this._levelView.getChild("back").asButton;for(let t=1;t<=F.LEVEL_NUM;t++){let e=this._levelView.getChild(`level_hitBtn_${t}`).asButton;e.onClick(this,this.onClickLevel,[t-1]),e.getController("button").on(fairygui.Events.STATE_CHANGED,this,this.onHitChanged,[t-1]);let i=new N(this._levelView.getChild(`level_btn_${t}`).asButton);this._levelBtns.push(i)}this.adapter(),this.reqLevelData()}onInitEvent(){this._backBtn.onClick(this,this.onClickBack),this._rewardBtn.onClick(this,this.onClickRward)}onRemoveEvent(){this._backBtn.offClick(this,this.onClickBack),this._rewardBtn.offClick(this,this.onClickRward)}adapter(){let t=Laya.Browser.clientWidth*Laya.Browser.pixelRatio,e=Laya.Browser.clientHeight*Laya.Browser.pixelRatio/(t/Laya.stage.designWidth);this._levelView.setSize(Laya.stage.designWidth,e),this._levelView.y=0}onClickBack(){Laya.Browser.window.location.href=e.activity_location}onClickRward(){0==this._levelData.game_prize_status?m.showComTipDlg("完成全部15关后记得领取\n银币*6666"):1==this._levelData.game_prize_status?C.instance.request(L.Game_Prize,{type:2},Laya.Handler.create(this,this.getPrizeOk)):2==this._levelData.game_prize_status&&m.showComTipDlg("奖励已领取")}getPrizeOk(t){0==t.ret&&(this._levelData.game_prize_status=2,this._rewardBtn.icon=`ui://Level/level_bx_${this._levelData.game_prize_status}`),m.showComTipDlg(t.error)}onClickLevel(t){if(t<=y.Instance.getGameLevel()){y.Instance.setGameLevel(t);let e=new W;D.show(e,s.LAY_SCENE),D.remove("LevelScene")}else m.showComTipDlg("别心急，先完成前面关卡")}reqLevelData(){C.instance.request(L.Game_Level,null,Laya.Handler.create(this,this.getLevelDataOk))}getLevelDataOk(t){this._levelData=t;for(let t=0;t<this._levelData.list.length;t++){let e=this._levelData.list[t],i=this._levelBtns[e.level];i&&i.initData(e),t==y.Instance.getGameLevel()&&i&&i.setCurrent()}this.setRewardState(),y.Instance.getGameLevel()<7&&this._levelView.scrollPane.setPercY(1,!0)}setRewardState(){this._rewardBtn.icon=`ui://Level/level_bx_${this._levelData.game_prize_status}`}onHitChanged(t,e){let i=this._levelBtns[t];1==e.selectedIndex?i.onPress():i.onRelease()}}F.LEVEL_NUM=15;var V=Laya.Loader;class j extends E{constructor(){super()}get res(){return[{url:r("Level.json"),type:V.BUFFER},{url:r("Level_atlas0.png"),type:V.IMAGE},{url:r("Common.json"),type:V.BUFFER},{url:r("Common_atlas0.png"),type:V.IMAGE},{url:r("Common_lu8n2d.mp3"),type:V.SOUND}]}onInit(t){super.onInit(),fairygui.UIPackage.addPackage(r("Common")),this.onInitBase("Level","main"),this._view=new F(this._ui),this._view.init()}onClose(){super.onClose(),this._view&&this._view.dispose()}}var z=Laya.Loader;class Y extends a{constructor(){super()}onInit(){super.onInit(),Laya.loader.on(Laya.Event.ERROR,this,this.onLoadError),this.progressHandler.runWith("加载游戏资源"),this._resList=[{url:r("Game.json"),type:z.BUFFER},{url:r("Game_atlas0.png"),type:z.IMAGE},{url:r("Level.json"),type:z.BUFFER},{url:r("Level_atlas0.png"),type:z.IMAGE},{url:r("Common.json"),type:z.BUFFER},{url:r("Common_atlas0.png"),type:z.IMAGE},{url:r("Common_lu8n2d.mp3"),type:z.SOUND},{url:c("hit.mp3"),type:z.SOUND},{url:c("eliminate.mp3"),type:z.SOUND},{url:c("gamewin.mp3"),type:z.SOUND},{url:c("gamelose.mp3"),type:z.SOUND},{url:_("spine/xiaoxiaole_eff_xiaochu.png"),type:z.IMAGE}]}start(){this._resList.length>0?Laya.loader.load(this._resList,Laya.Handler.create(this,this.onLoadComplete),Laya.Handler.create(this,this.onLoadProgress,null,!1)):this.complete(),b.Instance.loadSpineRes()}dispose(){super.dispose(),Laya.loader.off(Laya.Event.ERROR,this,this.onLoadError)}onLoadComplete(t){if(t){if(Laya.timer.once(200,this,()=>{document.getElementById("LoadBg").style.display="none"}),y.Instance.isBattle()){let t=new W;D.show(t,s.LAY_SCENE)}else{let t=new j;D.show(t,s.LAY_SCENE)}this.complete()}else this.errorHandler.runWith("加载游戏资源失败")}onLoadProgress(t,e){}onLoadError(t){this.progressHandler.runWith(`加载游戏资源失败: ${t}`)}}class ${constructor(){}init(){}start(){this.reset(),this.add(new f),this.add(new Y),this.begin()}reset(){this._total=0,this._progress=0,this._items=[],this._started=[]}begin(){const t=this._items.shift();t?(this._started.push(t),t.init(),t.start()):this.PrepareFinish()}add(t){this._items.push(t),t.completeHandler=Laya.Handler.create(this,this.onPrepareItemComplete,[t]),t.progressHandler=Laya.Handler.create(this,this.onPrepareItemProgress,[t],!1),t.errorHandler=Laya.Handler.create(this,this.onPrepareItemError,[t],!1)}addHead(t){this._items.unshift(t),t.completeHandler=Laya.Handler.create(this,this.onPrepareItemComplete,[t]),t.progressHandler=Laya.Handler.create(this,this.onPrepareItemProgress,[t],!1),t.errorHandler=Laya.Handler.create(this,this.onPrepareItemError,[t],!1)}onPrepareItemComplete(t){this.begin(),t.dispose()}onPrepareItemProgress(t,e){n.log(e)}onPrepareItemError(t,e){}PrepareFinish(){this.doFinished()}doFinished(){this.clear()}clear(){this._items=null,this._started=null}}new class{constructor(){window.Laya3D?Laya3D.init(t.width,t.height):Laya.init(t.width,t.height,Laya.WebGL),Laya.Physics&&Laya.Physics.enable(),Laya.DebugPanel&&Laya.DebugPanel.enable(),Laya.URL.exportSceneToJson=t.exportSceneToJson,(t.debug||"true"==Laya.Utils.getQueryString("debug"))&&Laya.enableDebugPanel(),t.physicsDebug&&Laya.PhysicsDebugDraw&&Laya.PhysicsDebugDraw.enable(),t.stat&&Laya.Stat.show(),Laya.alertGlobalError(!0),fairygui.UIConfig.packageFileExtension=t.fguitype,this.onConfigLoaded(),this.adapter(),Laya.stage.on(Laya.Event.VISIBILITY_CHANGE,this,this.onVisibilityChange)}onConfigLoaded(){Laya.stage.addChild(fairygui.GRoot.inst.displayObject),s.init(["scene","gui","top","tip"]),this._prepare=new $,this._prepare.init(),this._prepare.start()}adapter(){if(Laya.stage.screenMode=Laya.Stage.SCREEN_NONE,Laya.Browser.onPC)Laya.stage.scaleMode=Laya.Stage.SCALE_SHOWALL;else if(Laya.Browser.onAndroid||Laya.Browser.onIPhone){Laya.stage.scaleMode=Laya.Stage.SCALE_FIXED_WIDTH;let t=Laya.Browser.clientWidth*Laya.Browser.pixelRatio,i=Laya.Browser.clientHeight*Laya.Browser.pixelRatio,s=t/Laya.stage.designWidth,a=Math.round((Laya.stage.designHeight-i/s)/2);a>0&&(e.offset_top=a);let n=Math.round(i/s-Laya.stage.designHeight-158);n>158&&(n=158),n>0&&(e.offset_top=-n)}Laya.stage.alignV=Laya.Stage.ALIGN_MIDDLE,Laya.stage.alignH=Laya.Stage.ALIGN_CENTER}onVisibilityChange(){Laya.stage.isVisibility?A.instance.event(O.E_Visibility_Foreground):A.instance.event(O.E_Visibility_Background)}}}();